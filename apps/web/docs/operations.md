# 🔧 R-Stream 運用ドキュメント

## 📋 目次

1. [デプロイメント手順](#デプロイメント手順)
2. [監視設定](#監視設定)
3. [バックアップ手順](#バックアップ手順)
4. [障害対応手順](#障害対応手順)
5. [パフォーマンスチューニング](#パフォーマンスチューニング)
6. [セキュリティ監査](#セキュリティ監査)
7. [ログ管理](#ログ管理)

## デプロイメント手順

### 環境準備

1. 必要なツールのインストール

   - Node.js v18以上
   - PostgreSQL v14以上
   - Redis v6以上
   - AWS CLI v2以上

2. 環境変数の設定

   ```bash
   # .env.exampleをコピーして.envを作成
   cp .env.example .env

   # 必要な環境変数を設定
   DATABASE_URL=postgresql://user:password@localhost:5432/rstream
   REDIS_URL=redis://localhost:6379
   AWS_ACCESS_KEY_ID=your_access_key
   AWS_SECRET_ACCESS_KEY=your_secret_key
   ```

### デプロイメントフロー

1. コードの取得

   ```bash
   git clone https://github.com/RenRen62/R-Stream.git
   cd R-Stream
   ```

2. 依存関係のインストール

   ```bash
   # フロントエンド
   cd apps/web
   npm install

   # バックエンド
   cd ../../packages/server
   npm install
   ```

3. データベースのセットアップ

   ```bash
   # マイグレーションの実行
   npm run migrate

   # シードデータの投入（必要な場合）
   npm run seed
   ```

4. アプリケーションのビルド

   ```bash
   # フロントエンド
   cd ../../apps/web
   npm run build

   # バックエンド
   cd ../../packages/server
   npm run build
   ```

5. アプリケーションの起動

   ```bash
   # 開発環境
   npm run dev

   # 本番環境
   npm run start
   ```

## 監視設定

### 監視項目

1. システムリソース

   - CPU使用率
   - メモリ使用率
   - ディスク使用率
   - ネットワークトラフィック

2. アプリケーション

   - レスポンス時間
   - エラーレート
   - アクティブユーザー数
   - WebSocket接続数

3. データベース
   - クエリ実行時間
   - コネクションプール
   - デッドロック
   - レプリケーション遅延

### アラート設定

1. 重大度レベル

   - Critical: 即時対応が必要
   - Warning: 24時間以内の対応
   - Info: 監視のみ

2. 通知方法
   - Slack
   - メール
   - SMS（重大な障害時）

## バックアップ手順

### データベースバックアップ

1. 自動バックアップ

   ```bash
   # バックアップスクリプトの実行
   ./scripts/backup-db.sh
   ```

2. 手動バックアップ
   ```bash
   # 特定のデータベースのバックアップ
   pg_dump -U username -d database_name > backup.sql
   ```

### ファイルバックアップ

1. S3バックアップ

   ```bash
   # アーカイブデータのバックアップ
   aws s3 sync ./archives s3://rstream-backups/archives
   ```

2. 録画データのバックアップ
   ```bash
   # 録画データのバックアップ
   aws s3 sync ./recordings s3://rstream-backups/recordings
   ```

## 障害対応手順

### 障害レベル定義

1. レベル1（重大）

   - システム全体が停止
   - データの損失
   - セキュリティインシデント

2. レベル2（重要）

   - 主要機能の停止
   - パフォーマンスの大幅な低下
   - データの不整合

3. レベル3（軽微）
   - 一部機能の停止
   - パフォーマンスの低下
   - 一時的なエラー

### 対応フロー

1. 障害の検知

   - 監視システムからのアラート
   - ユーザーからの報告
   - システムログの確認

2. 初動対応

   - 影響範囲の特定
   - 一時的な回避策の実施
   - 関係者への通知

3. 原因調査

   - ログの分析
   - システム状態の確認
   - 再現手順の特定

4. 復旧作業

   - バックアップからの復元
   - 設定の修正
   - システムの再起動

5. 事後対応
   - 再発防止策の検討
   - ドキュメントの更新
   - 報告書の作成

## パフォーマンスチューニング

### 定期的なチェック項目

1. データベース

   - インデックスの最適化
   - クエリのパフォーマンス
   - コネクションプールの設定

2. アプリケーション

   - メモリリーク
   - CPU使用率
   - レスポンス時間

3. キャッシュ
   - ヒット率
   - メモリ使用量
   - 有効期限の設定

### チューニング手順

1. 現状分析

   - パフォーマンスメトリクスの収集
   - ボトルネックの特定
   - 改善目標の設定

2. 改善実施

   - コードの最適化
   - 設定の調整
   - インフラの拡張

3. 効果測定
   - 改善前後の比較
   - ユーザーへの影響確認
   - ドキュメントの更新

## セキュリティ監査

### 監査項目

1. アクセス制御

   - ユーザー権限
   - APIアクセス
   - ファイルアクセス

2. データ保護

   - 暗号化
   - バックアップ
   - データの削除

3. システム設定
   - ファイアウォール
   - セキュリティパッチ
   - ログ設定

### 監査手順

1. 準備

   - 監査計画の作成
   - 監査ツールの準備
   - 関係者への通知

2. 実施

   - システムの検査
   - ログの分析
   - 脆弱性の確認

3. 報告
   - 結果のまとめ
   - 改善提案
   - 対応計画の作成

## ログ管理

### ログ収集

1. アプリケーションログ

   - アクセスログ
   - エラーログ
   - パフォーマンスログ

2. システムログ
   - サーバーログ
   - データベースログ
   - セキュリティログ

### ログ分析

1. リアルタイム分析

   - エラーの検知
   - パフォーマンスの監視
   - セキュリティイベントの検出

2. 定期分析
   - トレンド分析
   - 異常検知
   - レポート作成

### ログ保存

1. 保存期間

   - アクセスログ: 90日
   - エラーログ: 180日
   - セキュリティログ: 365日

2. アーカイブ
   - 圧縮
   - 暗号化
   - 長期保存

## 🔄 更新履歴

| 日付       | 更新内容 | 更新者 |
| ---------- | -------- | ------ |
| 2025-05-31 | 初版作成 | -      |
